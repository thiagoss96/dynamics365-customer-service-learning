# Automa√ß√£o de Cria√ß√£o de Contatos a partir dos campos Email 2 e Email 3

## Vis√£o Geral

Este projeto demonstra uma automa√ß√£o no Microsoft Dynamics 365 / Dataverse utilizando Power Automate para cria√ß√£o autom√°tica de Contatos a partir dos campos Email Address 2 e Email Address 3 da entidade Conta (Account).

A solu√ß√£o foi pensada para cen√°rios reais de neg√≥cio, evitando duplicidade de contatos, respeitando relacionamentos com a conta e garantindo compatibilidade com integra√ß√µes externas e uso pelo time de Marketing.

---

## üéØ Objetivo da Solu√ß√£o

- Criar contatos automaticamente quando os campos Email 2 ou Email 3 da Conta forem preenchidos  
- Evitar cria√ß√£o de contatos duplicados dentro da mesma conta  
- Tratar diferentes padr√µes de e-mail (com ponto, h√≠fen ou sem separador)  
- Garantir preenchimento de campos obrigat√≥rios no Dataverse  
- Atender cen√°rios de integra√ß√£o sist√™mica e uso operacional por times de marketing

---

## Cen√°rios de Uso

### 1. Integra√ß√µes externas (ERP, Portais, APIs)

Quando uma integra√ß√£o cria ou atualiza contas no Dynamics 365 Customer Service e popula os campos Email 2 / Email 3, o fluxo:

- Detecta a altera√ß√£o automaticamente  
- Cria contatos relacionados √† conta  
- Evita duplicidade caso o contato j√° exista para aquela conta  

### Ocorr√™ncias Prim√°rias


![Inclu](./imagens/inclusaoemail.png)


---

### 2. Time de Marketing / Comercial

- Usu√°rios podem informar m√∫ltiplos e-mails na Conta  
- Cada e-mail gera automaticamente um contato  
- Os contatos podem ser usados em:
  - Jornadas de marketing  
  - Disparo de e-mails  
  - Campanhas  
  - Segmenta√ß√µes  

---

## Pr√©-requisitos

# Microsoft Dynamics 365 / Dataverse  
- Entidades:
  - Account (Conta)  
  - Contact (Contato)  
# Campos existentes na Conta:
  - emailaddress2  
  - emailaddress3  
# Campo obrigat√≥rio no Contato:
  - parentcustomerid (Nome da Empresa)  
- Power Automate (Cloud Flow)  

---

## Arquitetura do Fluxo

### Trigger

- Dataverse ‚Äì Quando uma linha √© adicionada ou modificada  
- Tabela: Account  
- Colunas monitoradas: emailaddress2, emailaddress3  

---

## L√≥gica do Fluxo (Resumo)

### Email Address 2

1. Verifica se o campo Email 2 est√° preenchido  
2. Lista contatos onde:
   - emailaddress1 = Email 2  
   - parentcustomerid = Conta atual  
3. Se nenhum contato for encontrado:
   - Cria um novo contato relacionado √† conta  

### Email Address 3

Repete exatamente a mesma l√≥gica aplicada ao Email 2.

---

## Tratamento Inteligente de Nome e Sobrenome

A automa√ß√£o extrai nome e sobrenome a partir do e-mail, respeitando diferentes padr√µes.

### Exemplos

| Email                   | Nome         | Sobrenome |
|------------------------|--------------|-----------|
| memphis.depay@parabelum | Memphis      | Depay    |
| yuri-alberto@equity.com | Yuri         | Alberto    |
| breno_bidon@yahoo.com  | Breno         | Bidon   |
| thiagosoares@gmail.com  | thiagosoares | Contato   |

Nota: para casos espec√≠ficos na qual o e-mail n√£o possua caracteres especiais, como: " . ", " - ", " _ ", de fato, a express√£o n√£o identificar√° qual √© o nome e sobrenome. Nesse caso, ser√° considerando nome e sobrenome no campo "nome" e chumbar de forma definitiva no campo: "sobrenome" a nomemclatura: "Contato".

### Express√£o ‚Äì Nome (Firstname)

```text
if(
  contains(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'.'),
  first(split(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'.')),
  if(
    contains(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'-'),
    first(split(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'-')),
    if(
      contains(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'_'),
      first(split(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'_')),
      split(triggerOutputs()?['body/emailaddress2'],'@')[0]
    )
  )
)


### Express√£o ‚Äì Sobrenome (Lastname)

```text
if(
  contains(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'.'),
  last(split(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'.')),
  if(
    contains(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'-'),
    last(split(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'-')),
    if(
      contains(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'_'),
      last(split(split(triggerOutputs()?['body/emailaddress2'],'@')[0],'_')),
      split(triggerOutputs()?['body/emailaddress2'],'@')[0]
    )
  )
)


## üìå Observa√ß√£o:
Para Email 3, basta substituir emailaddress2 por emailaddress3, na estrutura do fluxo para campo Email 3. 


### üîó Uso dos Composes na Cria√ß√£o do Contato

Na a√ß√£o Adicionar uma nova linha (Dataverse ‚Äì Contato):

First Name
‚Üí Conte√∫do din√¢mico do Compose ‚Äì Nome

Last Name
‚Üí Conte√∫do din√¢mico do Compose ‚Äì Sobrenome

Email Address 1
‚Üí Valor do Email 2 ou Email 3 da Conta

Nome da Empresa (parentcustomerid)
‚Üí triggerOutputs()?['body/accountid']

Dessa forma:

A - O contato √© corretamente relacionado √† conta

B - Os campos obrigat√≥rios s√£o preenchidos

C - A l√≥gica fica centralizada e reutiliz√°vel



## Boas Pr√°ticas Aplicadas:

1 -Uso de Compose para facilitar manuten√ß√£o

2 - Preven√ß√£o de duplicidade por conta

3 - Fallback para sobrenome

4 - Execu√ß√£o condicionada

5 - Estrutura preparada para escala

### üîê Preven√ß√£o de Duplicidade

A verifica√ß√£o √© feita por Conta, n√£o globalmente

Um mesmo e-mail pode existir em contas diferentes

Para a mesma conta, o contato n√£o ser√° duplicado

### üß™ Testes Realizados

Cria√ß√£o de conta com Email 2 preenchido

Cria√ß√£o de conta com Email 3 preenchido

Atualiza√ß√£o posterior da conta com novo e-mail

Execu√ß√£o m√∫ltipla sem duplicidade

Valida√ß√£o de campos obrigat√≥rios

### üìà Benef√≠cios para o Neg√≥cio

Redu√ß√£o de retrabalho manual

Padroniza√ß√£o de dados

Melhor qualidade de base para marketing

Escalabilidade para integra√ß√µes

Governan√ßa de dados no CRM


###Autor

Thiago Souza

Power Platform | Dynamics 365 | Automa√ß√£o de Processos
